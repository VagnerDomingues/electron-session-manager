name: Build Electron Session Manager

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  # Build x64 apps (stable)
  build-x64-apps:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # do not erase this comment - it is used to generate the matrix
        # os: [windows-latest, macos-latest, ubuntu-latest]
        # app: [asana, chatgpt, discord, notion, whatsappweb]
        os: [windows-latest, macos-latest, ubuntu-latest]
        app: [whatsappweb]
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest  
            platform: mac
          - os: ubuntu-latest
            platform: linux
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build ${{ matrix.app }} for ${{ matrix.platform }}-x64
      shell: bash
      run: |
        echo "üöÄ Building ${{ matrix.app }} for ${{ matrix.platform }}-x64..."
        
        # Backup current files if they exist
        if [ -f "package.json" ]; then
          cp package.json temp.package.json.backup
        fi
        if [ -f ".env" ]; then
          cp .env temp.env.backup
        fi
        
        # Copy app-specific configuration
        cp "configs/${{ matrix.app }}.package.json" package.json
        cp "configs/${{ matrix.app }}.env" .env
        
        # Build the app for x64 architecture only
        node scripts/build.js ${{ matrix.platform }} x64
        
        # Restore original files
        if [ -f "temp.package.json.backup" ]; then
          mv temp.package.json.backup package.json
        else
          rm -f package.json
        fi
        if [ -f "temp.env.backup" ]; then
          mv temp.env.backup .env
        else
          rm -f .env
        fi
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        SKIP_CODE_SIGNING: true
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create app-specific archive
      shell: bash
      run: |
        # Create archive directory
        mkdir -p archives

        # Get app display name from config
        APP_NAME=$(grep "APP_NAME=" "configs/${{ matrix.app }}.env" | cut -d'=' -f2 | tr -d '"')
        if [ -z "$APP_NAME" ]; then
          APP_NAME="${{ matrix.app }}"
        fi
        
        # Export APP_NAME for use in subsequent steps
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
        
        echo "üì¶ Creating archive for $APP_NAME (${{ matrix.app }}-${{ matrix.platform }}-x64)..."
        echo "üéØ Including only installer/executable files (no unpacked directories)"
        
        # Create archive based on platform with only installer/executable files
        cd "dist/${{ matrix.app }}"
        
        # Debug: List all files in the directory
        echo "üìÅ Files in dist/${{ matrix.app }}:"
        ls -la
          if [ "${{ matrix.platform }}" = "win" ]; then
          # Windows: Include NSIS installer, portable exe, and README (exclude win-unpacked folder and .yml files)
          echo "ü™ü Windows: Creating archive with installer files..."
          7z a "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.zip" *.exe *.md -x!win-unpacked -x!*.yml
        elif [ "${{ matrix.platform }}" = "mac" ]; then
          # macOS: Include DMG files and README (exclude .yml metadata files)
          echo "üçé macOS: Looking for .dmg files..."
          if ls *.dmg 1> /dev/null 2>&1; then
            echo "‚úÖ Found .dmg files, creating archive..."
            # Create archive with only DMG files and README (exclude .yml files)
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.dmg *.md 2>/dev/null || \
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.dmg 2>/dev/null || \
            echo "‚ö†Ô∏è Basic DMG archive created"
          else
            echo "‚ö†Ô∏è No .dmg files found, checking for other Mac files..."
            if ls *.app 1> /dev/null 2>&1; then
              echo "üì¶ Found .app bundles, creating archive..."
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.app *.md 2>/dev/null || \
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.app 2>/dev/null || \
              echo "No suitable Mac files found for archiving"
            elif ls -d mac* 2>/dev/null; then
              echo "üì¶ Found Mac directories, using find for selective archiving..."
              # Use find to select only installer files from directories
              find . -name "*.dmg" -o -name "*.pkg" | tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" -T - 2>/dev/null || \
              echo "No Mac installer files found" > build-info.txt && tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" build-info.txt
            else
              echo "‚ùå No Mac build artifacts found!"
              # Create an empty archive to avoid complete failure
              echo "Build completed but no Mac artifacts were generated" > build-info.txt
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" build-info.txt
            fi
          fi
          elif [ "${{ matrix.platform }}" = "linux" ]; then
          # Linux: Create separate archives for different package types
          echo "üêß Linux: Creating separate archives for different package types..."
          
          # Find x64-specific files (exclude ARM64 variants)
          # Use arrays to properly handle filenames with spaces
          readarray -t X64_APPIMAGES < <(ls *.AppImage 2>/dev/null | grep -v "arm64" | grep -v "aarch64" || true)
          readarray -t AMD64_DEBS < <(ls *amd64*.deb 2>/dev/null || true)
          
          # Create Debian/Ubuntu archive if .deb files exist
          if [ ${#AMD64_DEBS[@]} -gt 0 ]; then
            echo "‚úÖ Found amd64 deb packages, creating Debian/Ubuntu archive..."
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz" "${AMD64_DEBS[@]}" *.md 2>/dev/null || \
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz" "${AMD64_DEBS[@]}" 2>/dev/null
          fi
          
          # Create General Linux archive if AppImage files exist
          if [ ${#X64_APPIMAGES[@]} -gt 0 ]; then
            echo "‚úÖ Found x64 AppImage files, creating General Linux archive..."
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz" "${X64_APPIMAGES[@]}" *.md 2>/dev/null || \
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz" "${X64_APPIMAGES[@]}" 2>/dev/null
          fi
          
          # Fallback: if we have both types but want a combined archive as backup
          if [ ${#X64_APPIMAGES[@]} -gt 0 ] && [ ${#AMD64_DEBS[@]} -gt 0 ]; then
            echo "‚úÖ Creating combined Linux archive as backup..."
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" "${X64_APPIMAGES[@]}" "${AMD64_DEBS[@]}" *.md 2>/dev/null || \
            tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" "${X64_APPIMAGES[@]}" "${AMD64_DEBS[@]}" 2>/dev/null
          elif [ ${#X64_APPIMAGES[@]} -gt 0 ] || [ ${#AMD64_DEBS[@]} -gt 0 ]; then
            # If we only have one type, create a general archive too
            if [ ${#X64_APPIMAGES[@]} -gt 0 ]; then
              cp "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz" "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz"
            else
              cp "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz" "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz"
            fi
          else
            # Fallback for any other Linux files
            echo "‚ö†Ô∏è Looking for other Linux packages..."
            if ls *.AppImage 2>/dev/null | head -1 > /dev/null; then
              echo "‚úÖ Found AppImage files (all architectures), archiving..."
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.AppImage *.md 2>/dev/null || \
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.AppImage 2>/dev/null
            elif ls *.deb 2>/dev/null | head -1 > /dev/null; then
              echo "‚úÖ Found deb packages (all architectures), archiving..."
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.deb *.md 2>/dev/null || \
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" *.deb 2>/dev/null
            else
              echo "‚ö†Ô∏è No Linux packages found, creating info file..."
              echo "Linux build completed but no packages found" > build-info.txt
              tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" build-info.txt
            fi
          fi
        fi        # Verify archive was created and show contents
        if [ "${{ matrix.platform }}" = "win" ]; then
          echo "üìã Archive contents:"
          7z l "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.zip"
        elif [ "${{ matrix.platform }}" = "linux" ]; then
          echo "üìã Linux archive contents:"
          if [ -f "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz" ]; then
            echo "üêß Debian/Ubuntu archive:"
            tar -tzf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz"
          fi
          if [ -f "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz" ]; then
            echo "üêß General Linux archive:"
            tar -tzf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz"
          fi
          if [ -f "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz" ]; then
            echo "üêß Combined Linux archive:"
            tar -tzf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz"
          fi
        else
          echo "üìã Archive contents:"
          tar -tzf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz"
        fi
    # Upload Windows and macOS artifacts
    - name: Upload Windows artifact
      if: matrix.platform == 'win'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }} (windows-x64)
        path: archives/${{ matrix.app }}-${{ matrix.platform }}-x64.*
        retention-days: 90
        
    - name: Upload macOS artifact  
      if: matrix.platform == 'mac'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }} (apple-intel)
        path: archives/${{ matrix.app }}-${{ matrix.platform }}-x64.*
        retention-days: 90
        
    # Upload Linux artifacts (separate by package type)
    - name: Upload Linux Debian/Ubuntu artifact
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }} (debian & ubuntu & mint)
        path: archives/${{ matrix.app }}-${{ matrix.platform }}-x64-deb.tar.gz
        retention-days: 90

    - name: Upload Linux General artifact
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }} (general linux distros)
        path: archives/${{ matrix.app }}-${{ matrix.platform }}-x64-appimage.tar.gz
        retention-days: 90
        
#     # Fallback upload for Linux (combined archive)
#     - name: Upload Linux Combined artifact
#       if: matrix.platform == 'linux'
#       uses: actions/upload-artifact@v4
#       with:
#         name: ${{ env.APP_NAME }} (linux-x64)
#         path: archives/${{ matrix.app }}-${{ matrix.platform }}-x64.tar.gz
#         retention-days: 90

  # Apple Silicon builds (macOS ARM64)
  build-apple-silicon-apps:
    runs-on: macos-latest
    strategy:
      matrix:        
        app: [whatsappweb]  # Start with one app, will expand later: [asana, chatgpt, discord, notion, whatsappweb]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build ${{ matrix.app }} for Apple Silicon
      shell: bash
      run: |
        echo "üçé Building ${{ matrix.app }} for Apple Silicon (ARM64)..."
        
        # Backup current files if they exist
        if [ -f "package.json" ]; then
          cp package.json temp.package.json.backup
        fi
        if [ -f ".env" ]; then
          cp .env temp.env.backup
        fi
        
        # Copy app-specific configuration
        cp "configs/${{ matrix.app }}.package.json" package.json
        cp "configs/${{ matrix.app }}.env" .env
        
        # Build the app for arm64 architecture (Apple Silicon)
        node scripts/build.js mac arm64
        
        # Restore original files
        if [ -f "temp.package.json.backup" ]; then
          mv temp.package.json.backup package.json
        else
          rm -f package.json
        fi
        if [ -f "temp.env.backup" ]; then
          mv temp.env.backup .env
        else
          rm -f .env
        fi
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        SKIP_CODE_SIGNING: true
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Apple Silicon DMG
      shell: bash
      run: |
        # Create archive directory
        mkdir -p archives
        
        # Get app display name from config
        APP_NAME=$(grep "APP_NAME=" "configs/${{ matrix.app }}.env" | cut -d'=' -f2 | tr -d '"')
        if [ -z "$APP_NAME" ]; then
          APP_NAME="${{ matrix.app }}"
        fi
        
        # Export APP_NAME for use in subsequent steps
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

        echo "üçé Preparing Apple Silicon DMG for $APP_NAME..."
        
        # Navigate to build directory
        cd "dist/${{ matrix.app }}"
        
        # Debug: List all files in the directory
        echo "üìÅ Files in dist/${{ matrix.app }}:"
        ls -la
        # Find the ARM64 DMG file and copy it directly
        if ls *arm64*.dmg 1> /dev/null 2>&1; then
          ARM64_DMG=$(ls *arm64*.dmg | head -1)
          echo "‚úÖ Found Apple Silicon DMG: $ARM64_DMG"
          # Copy the DMG with the proper app name
          cp "$ARM64_DMG" "../../archives/$APP_NAME.dmg"
          echo "üì¶ Created: $APP_NAME.dmg"
        elif ls *.dmg 1> /dev/null 2>&1; then
          # Fallback: if no arm64-specific DMG, assume the DMG is ARM64 (since we built for ARM64)
          MAIN_DMG=$(ls *.dmg | head -1)
          echo "‚úÖ Found DMG (assuming ARM64): $MAIN_DMG"
          cp "$MAIN_DMG" "../../archives/$APP_NAME.dmg"
          echo "üì¶ Created: $APP_NAME.dmg"
        else          echo "‚ùå No DMG files found for Apple Silicon build!"
          echo "Available files:"
          ls -la
          # Create a placeholder file
          echo "Apple Silicon build failed - no DMG generated" > "../../archives/${{ matrix.app }}-apple-silicon-failed.txt"
        fi
        
    - name: Upload Apple Silicon artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }} (apple-silicon)
        path: archives/*.dmg
        retention-days: 90
        
  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-x64-apps, build-apple-silicon-apps]  # Include both x64 and Apple Silicon builds
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/asana-win-x64/*.zip
          artifacts/asana-mac-x64/*.tar.gz
          artifacts/asana-linux-x64/*.tar.gz
          artifacts/chatgpt-win-x64/*.zip
          artifacts/chatgpt-mac-x64/*.tar.gz
          artifacts/chatgpt-linux-x64/*.tar.gz
          artifacts/discord-win-x64/*.zip
          artifacts/discord-mac-x64/*.tar.gz
          artifacts/discord-linux-x64/*.tar.gz
          artifacts/notion-win-x64/*.zip
          artifacts/notion-mac-x64/*.tar.gz
          artifacts/notion-linux-x64/*.tar.gz
          artifacts/whatsappweb-win-x64/*.zip
          artifacts/whatsappweb-mac-x64/*.tar.gz
          artifacts/whatsappweb-linux-x64/*.tar.gz
          artifacts/whatsappweb-apple-silicon/*.dmg
        name: Electron Session Manager Apps Release ${{ github.ref_name }}
        body: |
          # üöÄ Electron Session Manager
          
          Download only the apps you need! Each application is available as a separate download for your platform.
          
          ## üì± Available Applications
          
          ### üéØ Asana Sessions - Project Management
          - [üì¶ Windows x64](../../releases/download/${{ github.ref_name }}/asana-win-x64.zip)
          - [üì¶ macOS x64 (Intel)](../../releases/download/${{ github.ref_name }}/asana-mac-x64.tar.gz)
          - [üì¶ Linux x64](../../releases/download/${{ github.ref_name }}/asana-linux-x64.tar.gz)
          
          ### ü§ñ ChatGPT Sessions - AI Assistant
          - [üì¶ Windows x64](../../releases/download/${{ github.ref_name }}/chatgpt-win-x64.zip)
          - [üì¶ macOS x64 (Intel)](../../releases/download/${{ github.ref_name }}/chatgpt-mac-x64.tar.gz)
          - [üì¶ Linux x64](../../releases/download/${{ github.ref_name }}/chatgpt-linux-x64.tar.gz)
          
          ### üéÆ Discord Sessions - Chat Platform  
          - [üì¶ Windows x64](../../releases/download/${{ github.ref_name }}/discord-win-x64.zip)
          - [üì¶ macOS x64 (Intel)](../../releases/download/${{ github.ref_name }}/discord-mac-x64.tar.gz)
          - [üì¶ Linux x64](../../releases/download/${{ github.ref_name }}/discord-linux-x64.tar.gz)
          
          ### üìù Notion Sessions - All-in-one Workspace
          - [üì¶ Windows x64](../../releases/download/${{ github.ref_name }}/notion-win-x64.zip)
          - [üì¶ macOS x64 (Intel)](../../releases/download/${{ github.ref_name }}/notion-mac-x64.tar.gz)
          - [üì¶ Linux x64](../../releases/download/${{ github.ref_name }}/notion-linux-x64.tar.gz)
          
          ### üí¨ WhatsApp Sessions - Messaging
          - [üì¶ Windows x64](../../releases/download/${{ github.ref_name }}/whatsappweb-win-x64.zip)
          - [üì¶ macOS x64 (Intel)](../../releases/download/${{ github.ref_name }}/whatsappweb-mac-x64.tar.gz)
          - [üì¶ Linux x64](../../releases/download/${{ github.ref_name }}/whatsappweb-linux-x64.tar.gz)
          - [üçé **macOS Apple Silicon (ARM64)**](../../releases/download/${{ github.ref_name }}/WhatsApp%20Sessions.dmg) ‚≠ê **NEW!**
          
          ## üèóÔ∏è Architecture Support
          
          This release includes:
          - **x64 (Intel/AMD)** builds for all platforms (Windows, macOS, Linux)
          - **Apple Silicon (ARM64)** builds for macOS (WhatsApp Sessions only - more apps coming soon!)
          
          **Coming Soon:**
          - ARM64 builds for all apps (Apple Silicon, Windows ARM, Raspberry Pi)
          - Mobile app versions (experimental)
          
          ## üîß Installation Instructions
          
          1. **Download** the app you want for your platform
          2. **Extract** the archive to a folder
          3. **Run** the application:
             - **Windows**: Double-click the `.exe` file
             - **macOS**: Double-click the `.app` bundle
             - **Linux**: Make executable and run: `chmod +x [app-name] && ./[app-name]`
          
          ## ‚ö†Ô∏è Security Note
          
          These applications are unsigned. You may need to:
          - **Windows**: Allow the app in Windows Defender SmartScreen
          - **macOS**: Allow the app in System Preferences > Security & Privacy  
          - **Linux**: Mark the executable as trusted
          
          ## üìù For Devs
          
          Want to build your own PWA with session management? or customize these apps? Visit the [repository](https://github.com/${{ github.repository }}) and follow the README instructions.
          
          ---
          
          Built with ‚ù§Ô∏è using [Electron Session Manager](https://github.com/${{ github.repository }})
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Mobile Builds (BETA) - Commented out for now
  # build-mobile-apps:
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     matrix:
  #       os: [macos-latest, ubuntu-latest]
  #       app: [asana, chatgpt, discord, notion, whatsappweb]
  #       platform: [android, ios]
  #       exclude:
  #         # iOS can only be built on macOS
  #         - os: ubuntu-latest
  #           platform: ios
  #       include:
  #         - os: macos-latest
  #           platform: ios
  #           target_ext: .ipa
  #         - os: ubuntu-latest  
  #           platform: android
  #           target_ext: .apk
  #         - os: macos-latest
  #           platform: android
  #           target_ext: .apk
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '18'
  #       cache: 'npm'
  #       
  #   - name: Install dependencies
  #     run: npm ci
  #     
  #   - name: Setup Capacitor for mobile builds
  #     run: |
  #       npm install -g @capacitor/cli @capacitor/core
  #       npm install @capacitor/android @capacitor/ios
  #       
  #   - name: Setup Android SDK (for Android builds)
  #     if: matrix.platform == 'android'
  #     uses: android-actions/setup-android@v3
  #     with:
  #       api-level: 33
  #       
  #   - name: Setup Xcode (for iOS builds)
  #     if: matrix.platform == 'ios'
  #     uses: maxim-lobanov/setup-xcode@v1
  #     with:
  #       xcode-version: latest-stable
  #       
  #   - name: Build mobile app (BETA)
  #     shell: bash
  #     run: |
  #       echo "üì± Building EXPERIMENTAL ${{ matrix.app }} for ${{ matrix.platform }}..."
  #       echo "‚ö†Ô∏è  This is a beta feature - mobile builds are experimental"
  #       
  #       # Backup current files if they exist
  #       if [ -f "package.json" ]; then
  #         cp package.json temp.package.json.backup
  #       fi
  #       if [ -f ".env" ]; then
  #         cp .env temp.env.backup
  #       fi
  #       
  #       # Copy app-specific configuration
  #       cp "configs/${{ matrix.app }}.package.json" package.json
  #       cp "configs/${{ matrix.app }}.env" .env
  #       
  #       # Initialize Capacitor project
  #       npx cap init "${{ matrix.app }}" "com.pwadesktop.${{ matrix.app }}"
  #       
  #       # Create basic web assets for mobile
  #       mkdir -p www
  #       cat > www/index.html << 'EOF'
  #       <!DOCTYPE html>
  #       <html>
  #       <head>
  #         <meta charset="utf-8">
  #         <meta name="viewport" content="width=device-width, initial-scale=1.0">
  #         <title>${{ matrix.app }}</title>
  #         <style>
  #           body { margin: 0; padding: 0; }
  #           webview { width: 100vw; height: 100vh; border: none; }
  #         </style>
  #       </head>
  #       <body>
  #         <webview id="main-webview"></webview>
  #         <script>
  #           const webview = document.getElementById('main-webview');
  #           // Load the PWA URL from environment
  #           const url = process.env.PWA_URL || 'https://web.whatsapp.com';
  #           webview.src = url;
  #         </script>
  #       </body>
  #       </html>
  #       EOF
  #       
  #       # Add platform
  #       if [ "${{ matrix.platform }}" = "android" ]; then
  #         npx cap add android
  #         npx cap sync android
  #         cd android
  #         ./gradlew assembleDebug
  #         cd ..
  #         mkdir -p dist/mobile
  #         cp android/app/build/outputs/apk/debug/app-debug.apk "dist/mobile/${{ matrix.app }}-android.apk"
  #       elif [ "${{ matrix.platform }}" = "ios" ]; then
  #         npx cap add ios
  #         npx cap sync ios
  #         # Note: iOS builds require code signing, this is just a structure setup
  #         echo "üì± iOS project structure created. Manual Xcode build required for distribution."
  #         mkdir -p dist/mobile
  #         echo "iOS project ready for Xcode build" > "dist/mobile/${{ matrix.app }}-ios-project.txt"
  #       fi
  #       
  #       # Restore original files
  #       if [ -f "temp.package.json.backup" ]; then
  #         mv temp.package.json.backup package.json
  #       else
  #         rm -f package.json
  #       fi
  #       if [ -f "temp.env.backup" ]; then
  #         mv temp.env.backup .env
  #       else
  #         rm -f .env
  #       fi
  #     env:
  #       CSC_IDENTITY_AUTO_DISCOVERY: false
  #       SKIP_CODE_SIGNING: true
  #       
  #   - name: Upload mobile artifact (BETA)
  #     uses: actions/upload-artifact@v4
  #     if: success()
  #     with:
  #       name: ${{ matrix.app }}-${{ matrix.platform }}-beta
  #       path: dist/mobile/${{ matrix.app }}-${{ matrix.platform }}*
  #       retention-days: 30
