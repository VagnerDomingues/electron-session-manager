name: Build Electron Session Manager

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-individual-apps:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        app: [asana, chatgpt, discord, notion, whatsappweb]
        arch: [x64, arm64]
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest  
            platform: mac
          - os: ubuntu-latest
            platform: linux
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build ${{ matrix.app }} for ${{ matrix.platform }}-${{ matrix.arch }}
      shell: bash
      run: |
        echo "ðŸš€ Building ${{ matrix.app }} for ${{ matrix.platform }}-${{ matrix.arch }}..."
        
        # Backup current files if they exist
        if [ -f "package.json" ]; then
          cp package.json temp.package.json.backup
        fi
        if [ -f ".env" ]; then
          cp .env temp.env.backup
        fi
        
        # Copy app-specific configuration
        cp "configs/${{ matrix.app }}.package.json" package.json
        cp "configs/${{ matrix.app }}.env" .env
        
        # Build the app for specific architecture
        node scripts/build.js ${{ matrix.platform }} ${{ matrix.arch }}
        
        # Restore original files
        if [ -f "temp.package.json.backup" ]; then
          mv temp.package.json.backup package.json
        else
          rm -f package.json
        fi
        if [ -f "temp.env.backup" ]; then
          mv temp.env.backup .env
        else
          rm -f .env
        fi
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        SKIP_CODE_SIGNING: true
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create app-specific archive
      shell: bash
      run: |
        # Create archive directory
        mkdir -p archives
        
        # Get app display name from config
        APP_NAME=$(grep "APP_NAME=" "configs/${{ matrix.app }}.env" | cut -d'=' -f2 | tr -d '"')
        if [ -z "$APP_NAME" ]; then
          APP_NAME="${{ matrix.app }}"
        fi
        
        echo "ðŸ“¦ Creating archive for $APP_NAME (${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }})..."
        
        # Create archive based on platform
        if [ "${{ matrix.platform }}" = "win" ]; then
          cd "dist/${{ matrix.app }}"
          7z a "../../archives/${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }}.zip" ./*
        else
          cd "dist/${{ matrix.app }}"
          tar -czf "../../archives/${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz" ./*
        fi
        
    - name: Upload ${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }}
        path: archives/${{ matrix.app }}-${{ matrix.platform }}-${{ matrix.arch }}.*
        retention-days: 90
  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-individual-apps
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/asana-win-x64/*.zip
          artifacts/asana-win-arm64/*.zip
          artifacts/asana-mac-x64/*.tar.gz
          artifacts/asana-mac-arm64/*.tar.gz
          artifacts/asana-linux-x64/*.tar.gz
          artifacts/asana-linux-arm64/*.tar.gz
          artifacts/chatgpt-win-x64/*.zip
          artifacts/chatgpt-win-arm64/*.zip
          artifacts/chatgpt-mac-x64/*.tar.gz
          artifacts/chatgpt-mac-arm64/*.tar.gz
          artifacts/chatgpt-linux-x64/*.tar.gz
          artifacts/chatgpt-linux-arm64/*.tar.gz
          artifacts/discord-win-x64/*.zip
          artifacts/discord-win-arm64/*.zip
          artifacts/discord-mac-x64/*.tar.gz
          artifacts/discord-mac-arm64/*.tar.gz
          artifacts/discord-linux-x64/*.tar.gz
          artifacts/discord-linux-arm64/*.tar.gz
          artifacts/notion-win-x64/*.zip
          artifacts/notion-win-arm64/*.zip
          artifacts/notion-mac-x64/*.tar.gz
          artifacts/notion-mac-arm64/*.tar.gz
          artifacts/notion-linux-x64/*.tar.gz
          artifacts/notion-linux-arm64/*.tar.gz
          artifacts/whatsappweb-win-x64/*.zip
          artifacts/whatsappweb-win-arm64/*.zip
          artifacts/whatsappweb-mac-x64/*.tar.gz
          artifacts/whatsappweb-mac-arm64/*.tar.gz
          artifacts/whatsappweb-linux-x64/*.tar.gz
          artifacts/whatsappweb-linux-arm64/*.tar.gz
        name: PWA Desktop Apps Release ${{ github.ref_name }}
        body: |
          # ðŸš€ Electron Session Manager - Individual Desktop Apps
          
          Download only the apps you need! Each application is available as a separate download for your platform and architecture.
          
          ## ðŸ“± Available Applications
          
          ### ðŸŽ¯ Asana - Project Management
          **Windows**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/asana-win-x64.zip)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/asana-win-arm64.zip)
          
          **macOS**  
          - [ðŸ“¦ x64 (Intel)](../../releases/download/${{ github.ref_name }}/asana-mac-x64.tar.gz)
          - [ðŸ“¦ ARM64 (Apple Silicon)](../../releases/download/${{ github.ref_name }}/asana-mac-arm64.tar.gz)
          
          **Linux**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/asana-linux-x64.tar.gz)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/asana-linux-arm64.tar.gz)
          
          ### ðŸ¤– ChatGPT - AI Assistant
          **Windows**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/chatgpt-win-x64.zip)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/chatgpt-win-arm64.zip)
          
          **macOS**
          - [ðŸ“¦ x64 (Intel)](../../releases/download/${{ github.ref_name }}/chatgpt-mac-x64.tar.gz)
          - [ðŸ“¦ ARM64 (Apple Silicon)](../../releases/download/${{ github.ref_name }}/chatgpt-mac-arm64.tar.gz)
          
          **Linux**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/chatgpt-linux-x64.tar.gz)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/chatgpt-linux-arm64.tar.gz)
          
          ### ðŸŽ® Discord - Chat Platform  
          **Windows**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/discord-win-x64.zip)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/discord-win-arm64.zip)
          
          **macOS**
          - [ðŸ“¦ x64 (Intel)](../../releases/download/${{ github.ref_name }}/discord-mac-x64.tar.gz)
          - [ðŸ“¦ ARM64 (Apple Silicon)](../../releases/download/${{ github.ref_name }}/discord-mac-arm64.tar.gz)
          
          **Linux**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/discord-linux-x64.tar.gz)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/discord-linux-arm64.tar.gz)
          
          ### ðŸ“ Notion - All-in-one Workspace
          **Windows**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/notion-win-x64.zip)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/notion-win-arm64.zip)
          
          **macOS**
          - [ðŸ“¦ x64 (Intel)](../../releases/download/${{ github.ref_name }}/notion-mac-x64.tar.gz)
          - [ðŸ“¦ ARM64 (Apple Silicon)](../../releases/download/${{ github.ref_name }}/notion-mac-arm64.tar.gz)
          
          **Linux**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/notion-linux-x64.tar.gz)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/notion-linux-arm64.tar.gz)
          
          ### ðŸ’¬ WhatsApp Web - Messaging
          **Windows**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/whatsappweb-win-x64.zip)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/whatsappweb-win-arm64.zip)
          
          **macOS**
          - [ðŸ“¦ x64 (Intel)](../../releases/download/${{ github.ref_name }}/whatsappweb-mac-x64.tar.gz)
          - [ðŸ“¦ ARM64 (Apple Silicon)](../../releases/download/${{ github.ref_name }}/whatsappweb-mac-arm64.tar.gz)
          
          **Linux**
          - [ðŸ“¦ x64 (Intel/AMD)](../../releases/download/${{ github.ref_name }}/whatsappweb-linux-x64.tar.gz)
          - [ðŸ“¦ ARM64](../../releases/download/${{ github.ref_name }}/whatsappweb-linux-arm64.tar.gz)
          
          ## ðŸ—ï¸ Architecture Support
          
          - **x64**: Traditional Intel/AMD 64-bit processors
          - **ARM64**: ARM-based processors (Apple Silicon, Windows ARM, Raspberry Pi 4+)
          
          ## ðŸ”§ Installation Instructions
          
          1. **Download** the app you want for your platform and architecture
          2. **Extract** the archive to a folder
          3. **Run** the application:
             - **Windows**: Double-click the `.exe` file
             - **macOS**: Double-click the `.app` bundle
             - **Linux**: Make executable and run: `chmod +x [app-name] && ./[app-name]`
          
          ## âš ï¸ Security Note
          
          These applications are unsigned. You may need to:
          - **Windows**: Allow the app in Windows Defender SmartScreen
          - **macOS**: Allow the app in System Preferences > Security & Privacy  
          - **Linux**: Mark the executable as trusted
          
          ## ðŸ“ Customization
          
          Want to build your own PWA or customize these apps? Visit the [repository](https://github.com/${{ github.repository }}) and follow the README instructions.
          
          ---
          
          Built with â¤ï¸ using [Electron Session Manager](https://github.com/${{ github.repository }})
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Experimental Mobile Builds (Beta)
  build-mobile-apps:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        app: [asana, chatgpt, discord, notion, whatsappweb]
        platform: [android, ios]
        exclude:
          # iOS can only be built on macOS
          - os: ubuntu-latest
            platform: ios
        include:
          - os: macos-latest
            platform: ios
            target_ext: .ipa
          - os: ubuntu-latest  
            platform: android
            target_ext: .apk
          - os: macos-latest
            platform: android
            target_ext: .apk
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Capacitor for mobile builds
      run: |
        npm install -g @capacitor/cli @capacitor/core
        npm install @capacitor/android @capacitor/ios
        
    - name: Setup Android SDK (for Android builds)
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        
    - name: Setup Xcode (for iOS builds)
      if: matrix.platform == 'ios'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build mobile app (BETA)
      shell: bash
      run: |
        echo "ðŸ“± Building EXPERIMENTAL ${{ matrix.app }} for ${{ matrix.platform }}..."
        echo "âš ï¸  This is a beta feature - mobile builds are experimental"
        
        # Backup current files if they exist
        if [ -f "package.json" ]; then
          cp package.json temp.package.json.backup
        fi
        if [ -f ".env" ]; then
          cp .env temp.env.backup
        fi
        
        # Copy app-specific configuration
        cp "configs/${{ matrix.app }}.package.json" package.json
        cp "configs/${{ matrix.app }}.env" .env
        
        # Initialize Capacitor project
        npx cap init "${{ matrix.app }}" "com.pwadesktop.${{ matrix.app }}"
        
        # Create basic web assets for mobile
        mkdir -p www
        cat > www/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${{ matrix.app }}</title>
          <style>
            body { margin: 0; padding: 0; }
            webview { width: 100vw; height: 100vh; border: none; }
          </style>
        </head>
        <body>
          <webview id="main-webview"></webview>
          <script>
            const webview = document.getElementById('main-webview');
            // Load the PWA URL from environment
            const url = process.env.PWA_URL || 'https://web.whatsapp.com';
            webview.src = url;
          </script>
        </body>
        </html>
        EOF
        
        # Add platform
        if [ "${{ matrix.platform }}" = "android" ]; then
          npx cap add android
          npx cap sync android
          cd android
          ./gradlew assembleDebug
          cd ..
          mkdir -p dist/mobile
          cp android/app/build/outputs/apk/debug/app-debug.apk "dist/mobile/${{ matrix.app }}-android.apk"
        elif [ "${{ matrix.platform }}" = "ios" ]; then
          npx cap add ios
          npx cap sync ios
          # Note: iOS builds require code signing, this is just a structure setup
          echo "ðŸ“± iOS project structure created. Manual Xcode build required for distribution."
          mkdir -p dist/mobile
          echo "iOS project ready for Xcode build" > "dist/mobile/${{ matrix.app }}-ios-project.txt"
        fi
        
        # Restore original files
        if [ -f "temp.package.json.backup" ]; then
          mv temp.package.json.backup package.json
        else
          rm -f package.json
        fi
        if [ -f "temp.env.backup" ]; then
          mv temp.env.backup .env
        else
          rm -f .env
        fi
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        SKIP_CODE_SIGNING: true
        
    - name: Upload mobile artifact (BETA)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ${{ matrix.app }}-${{ matrix.platform }}-beta
        path: dist/mobile/${{ matrix.app }}-${{ matrix.platform }}*
        retention-days: 30
